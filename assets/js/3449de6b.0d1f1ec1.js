"use strict";(self.webpackChunknewsite=self.webpackChunknewsite||[]).push([[76058],{3905:(e,n,t)=>{t.r(n),t.d(n,{MDXContext:()=>d,MDXProvider:()=>c,mdx:()=>f,useMDXComponents:()=>p,withMDXComponents:()=>m});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(){return o=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},o.apply(this,arguments)}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var d=a.createContext({}),m=function(e){return function(n){var t=p(n.components);return a.createElement(e,o({},n,{components:t}))}},p=function(e){var n=a.useContext(d),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},c=function(e){var n=p(e.components);return a.createElement(d.Provider,{value:n},e.children)},u="mdxType",g={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},h=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),m=p(t),c=r,u=m["".concat(i,".").concat(c)]||m[c]||g[c]||o;return t?a.createElement(u,l(l({ref:n},d),{},{components:t})):a.createElement(u,l({ref:n},d))}));function f(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,i=new Array(o);i[0]=h;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[u]="string"==typeof e?e:r,i[1]=l;for(var d=2;d<o;d++)i[d]=t[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}h.displayName="MDXCreateElement"},81194:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>d});var a=t(87462),r=(t(67294),t(3905));const o={title:"Generate Art Using Latent Diffusion Models and NFC Tags",description:"Learn how to host the Stable  for performing text-to-image generation tasks on the Oracle Cloud Infrastructure (OCI). Then, build an Oracle APEX application that uses NFC tags to receive text prompts and use it to generate an image.",image:"./assets/image20231119221347.png",tags:["latent diffusion model","ldm","machine learning","oci","python","conda","oracle apex","generative ai","ai-generated art","mlops","nfc","text-to-image generation"],categories:["Technology"],authors:["fuzziebrain"],date:new Date("2023-11-19T21:00:00.000Z")},i=void 0,l={permalink:"/content/generate-art-using-diffusion-models-and-nfc-tags",source:"@site/posts/generate-art-using-diffusion-models-and-nfc-tags/index.md",title:"Generate Art Using Latent Diffusion Models and NFC Tags",description:"Learn how to host the Stable  for performing text-to-image generation tasks on the Oracle Cloud Infrastructure (OCI). Then, build an Oracle APEX application that uses NFC tags to receive text prompts and use it to generate an image.",date:"2023-11-19T21:00:00.000Z",formattedDate:"November 19, 2023",tags:[{label:"latent diffusion model",permalink:"/content/tags/latent-diffusion-model"},{label:"ldm",permalink:"/content/tags/ldm"},{label:"machine learning",permalink:"/content/tags/machine-learning"},{label:"oci",permalink:"/content/tags/oci"},{label:"python",permalink:"/content/tags/python"},{label:"conda",permalink:"/content/tags/conda"},{label:"oracle apex",permalink:"/content/tags/oracle-apex"},{label:"generative ai",permalink:"/content/tags/generative-ai"},{label:"ai-generated art",permalink:"/content/tags/ai-generated-art"},{label:"mlops",permalink:"/content/tags/mlops"},{label:"nfc",permalink:"/content/tags/nfc"},{label:"text-to-image generation",permalink:"/content/tags/text-to-image-generation"}],readingTime:10.62,hasTruncateMarker:!0,authors:[{name:"Adrian Png",title:"Senior Cloud Solutions Architect @ Insum",url:"https://github.com/fuzziebrain",imageURL:"https://github.com/fuzziebrain.png",key:"fuzziebrain"}],frontMatter:{title:"Generate Art Using Latent Diffusion Models and NFC Tags",description:"Learn how to host the Stable  for performing text-to-image generation tasks on the Oracle Cloud Infrastructure (OCI). Then, build an Oracle APEX application that uses NFC tags to receive text prompts and use it to generate an image.",image:"./assets/image20231119221347.png",tags:["latent diffusion model","ldm","machine learning","oci","python","conda","oracle apex","generative ai","ai-generated art","mlops","nfc","text-to-image generation"],categories:["Technology"],authors:["fuzziebrain"],date:"2023-11-19T21:00:00.000Z"},nextItem:{title:"Deploy and Use Fine-Tuned LLMs in Oracle APEX",permalink:"/content/deploy-and-use-fine-tuned-llms-in-oracle-apex"}},s={image:t(57699).Z,authorsImageUrls:[void 0]},d=[{value:"Deploying the Model",id:"deploying-the-model",level:2},{value:"Setup the Server Environment",id:"setup-the-server-environment",level:3},{value:"Write the Server-Side Code",id:"write-the-server-side-code",level:3},{value:"Run the Server",id:"run-the-server",level:3},{value:"Deploy an OCI API Gateway",id:"deploy-an-oci-api-gateway",level:3},{value:"Testing the Model",id:"testing-the-model",level:3},{value:"The NFC-Enabled Web Application",id:"the-nfc-enabled-web-application",level:2},{value:"Writing to NFC Tags",id:"writing-to-nfc-tags",level:2},{value:"Summary",id:"summary",level:2}],m={toc:d};function p(e){let{components:n,...o}=e;return(0,r.mdx)("wrapper",(0,a.Z)({},m,o,{components:n,mdxType:"MDXLayout"}),(0,r.mdx)("p",null,(0,r.mdx)("img",{alt:"Photo of a bird perched on a tree, generated using a Stability Diffusion model.",src:t(57699).Z,width:"1280",height:"720"})),(0,r.mdx)("p",null,"In my previous ",(0,r.mdx)("a",{parentName:"p",href:"/content/deploy-and-use-fine-tuned-llms-in-oracle-apex"},"post"),", you read about how I performed fine-tuning and deployed a large language model (LLM) on the ",(0,r.mdx)("a",{parentName:"p",href:"https://oracle.com/cloud"},"Oracle Cloud Infrastructure")," (OCI) ",(0,r.mdx)("a",{parentName:"p",href:"https://www.oracle.com/artificial-intelligence/data-science/"},"Data Science")," service. Here, I was hoping to do the same with the ",(0,r.mdx)("a",{parentName:"p",href:"https://stability.ai/stable-diffusion"},"Stable Diffusion XL"),", a ",(0,r.mdx)("em",{parentName:"p"},"Latent Diffusion Model")," (LDM), but unfortunately, the platform currently does not support a ",(0,r.mdx)("a",{parentName:"p",href:"https://huggingface.co"},(0,r.mdx)("em",{parentName:"a"},"Hugging Face"))," pipeline using this model. I found an alternative, and you will read about it later in this article."),(0,r.mdx)("p",null,"To demonstrate its utility, I create a simple ",(0,r.mdx)("a",{parentName:"p",href:"https://apex.oracle.com"},"Oracle APEX")," application that reads NFC tags using the ",(0,r.mdx)("strong",{parentName:"p"},"experimental")," ",(0,r.mdx)("a",{parentName:"p",href:"https://w3c.github.io/web-nfc/"},(0,r.mdx)("em",{parentName:"a"},"Web NFC"))," API, and then displays an image generated by the deployed machine learning (ML) model."),(0,r.mdx)("p",null,'I called this toy application "Amiibo Art". The ',(0,r.mdx)("a",{parentName:"p",href:"https://www.nintendo.com/amiibo/"},"Amiibo")," was created by ",(0,r.mdx)("em",{parentName:"p"},"Nintendo")," to bridge games with the real world using toys, figurines, and collectibles that embedded a radio-frequency tag. I wanted this APEX application to interact with the real world, and then generate a collectible. If you missed it, here's the screen recording of the application in action:"),(0,r.mdx)("youtube",{youTubeId:"aozXI0NWlKs"}),(0,r.mdx)("h2",{id:"deploying-the-model"},"Deploying the Model"),(0,r.mdx)("p",null,"As mentioned earlier, the OCI Data Science platform did not provide me an easy way to deploy the Stable Diffusion XL model. I found an open-source project called ",(0,r.mdx)("a",{parentName:"p",href:"https://pinferencia.underneathall.app/"},(0,r.mdx)("em",{parentName:"a"},"Pinferenia"))," that I could use to deploy a Hugging Face pipeline to perform the text-to-image generation task. The code below can be executed and deployed on an OCI Compute, and a GPU, while not required, is desired."),(0,r.mdx)("h3",{id:"setup-the-server-environment"},"Setup the Server Environment"),(0,r.mdx)("p",null,"The first task involved setting up a new ",(0,r.mdx)("a",{parentName:"p",href:"https://conda.io"},"Conda")," environment with the required dependencies using the ",(0,r.mdx)("a",{parentName:"p",href:"https://yaml.org/"},"YAML")," file below:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-yaml"},"channels:\n    - conda-forge\n    - pytorch\n    - nvidia\n\ndependencies:\n    - python=3.9\n    - pytorch\n    - pytorch-cuda\n    - transformers\n    - pillow\n    - numpy\n    - safetensors\n    - diffusers\n    - accelerate\n    - pip\n    - pip:\n        - invisible_watermark\n        - oracle-ads\n        - pinferencia\n")),(0,r.mdx)("p",null,"If you are new to Conda, write the YAML contents into a file name ",(0,r.mdx)("inlineCode",{parentName:"p"},"amiibo-art.yaml"),", install the Conda software, and then execute the command:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-bash"},"conda env create -n amiibo-art -f amiibo-art.yaml\n")),(0,r.mdx)("p",null,"Then, as instructed, activate the environment before running the subsequent code and commands. To activate the newly created environment, execute the command:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-bash"},"conda activate amiibo-art\n")),(0,r.mdx)("h3",{id:"write-the-server-side-code"},"Write the Server-Side Code"),(0,r.mdx)("p",null,"Create the Python file ",(0,r.mdx)("inlineCode",{parentName:"p"},"app.py")," with the code provided below. Follow the embedded comments to understand what it is doing."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-python"},'from diffusers import DiffusionPipeline\nfrom pinferencia import Server\nimport torch\nimport datetime\nimport os\nimport oci.object_storage\n\ndef get_current_timestamp():\n    """\n    Return a timestamp for file naming purposes.\n    """\n    now = datetime.datetime.now()\n    return now.strftime(\'%Y%m%d%H%M%S\')\n\ndef save_object(bucketName, objectName, content):\n    """\n    Save the generated image in an Object Storage bucket for retrieval later.\n    """\n    mimeType = "image/png"\n\n    object = client.put_object(\n        namespace_name = namespace\n        , bucket_name = bucketName\n        , object_name = objectName\n        , content_type = mimeType\n        , put_object_body = content\n    )\n\ndef generate(prompt):\n    """\n    This function is registered to the Pinferencia as the model "genai". It\n    generates the image using the Hugging Face pipeline, save the output as a\n    file, then push it to the Object Storage bucket using the function\n    "save_object".\n    """\n    bucketName = "amiibo"\n    objectName = f"image{get_current_timestamp()}.png"\n    image = pipe(prompt=prompt, width=1280, height=720).images[0]\n    image.save(objectName)\n    content = open(objectName, "rb")\n    save_object(bucketName=bucketName, objectName=objectName, content=content)\n    os.remove(objectName)\n    return {"bucket_name": bucketName, "object_name": objectName}\n\n"""\nWe will use an instance principal to sign the request. Be sure to:\n1. Create a dynamic group that includes the Compute instance\'s OCID.\n2. Create an IAM policy that has the necessary statements to allow the dynamic\n   group to write to the bucket.\n"""\nsigner = oci.auth.signers.InstancePrincipalsSecurityTokenSigner()\nclient = oci.object_storage.ObjectStorageClient(config={"region":"***",\n    "tenancy":signer.tenancy_id}, signer=signer)\nnamespace = client.get_namespace().data\n\n"""\nCreate a Hugging Face pipeline using the Stable Diffusion XL model hosted on the\nplatform. We will use the quantized model.\n"""\npipe = DiffusionPipeline.from_pretrained("stabilityai/stable-diffusion-xl-base-1.0",\n        use_safetensors=True, torch_dtype=torch.float16, variant="fp16")\n\n"""\nUse a Nvidia GPU, if available.\n"""\npipe.to("cuda" if torch.cuda.is_available() else "cpu")\n\n"""\nInstantiate the Pinferencia server.\n"""\nservice = Server()\n\n"""\nRegister the "generate" function as the model "genai".\n"""\nservice.register(model_name="genai", model=generate,\n    metadata={"platform":"Linux", "device": "GPU"})\n')),(0,r.mdx)("h3",{id:"run-the-server"},"Run the Server"),(0,r.mdx)("p",null,"The Pinferencia package includes executables for running a server instance. For simplicity, I ran the server in the background using ",(0,r.mdx)("a",{parentName:"p",href:"https://github.com/tmux/tmux"},"tmux")," (think ",(0,r.mdx)("em",{parentName:"p"},"screen"),"), and executing the command:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-bash"},"pinfer --backend-host 0.0.0.0 --mode backend app:service --reload\n")),(0,r.mdx)("blockquote",null,(0,r.mdx)("p",{parentName:"blockquote"},(0,r.mdx)("strong",{parentName:"p"},"NOTE")),(0,r.mdx)("p",{parentName:"blockquote"},"By default, the server only binds and listens to the local interface, i.e., ",(0,r.mdx)("inlineCode",{parentName:"p"},"localhost")," or IP address ",(0,r.mdx)("inlineCode",{parentName:"p"},"127.0.0.1"),". Hence, the command includes the parameter ",(0,r.mdx)("inlineCode",{parentName:"p"},"--backend-host 0.0.0.0"),".")),(0,r.mdx)("p",null,"The deployed model is accessible at an endpoint URL with a format that looks like this:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"http://{{HOST_IP}}:8000/v1/models/{{MODEL_NAME}}/predict\n")),(0,r.mdx)("p",null,"For example:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"http://10.30.4.23:8000/v1/models/genai/predict\n")),(0,r.mdx)("h3",{id:"deploy-an-oci-api-gateway"},"Deploy an OCI API Gateway"),(0,r.mdx)("p",null,"As I am calling this web service from an Oracle Autonomous Database that is ",(0,r.mdx)("strong",{parentName:"p"},"not")," using a private endpoint, I needed to proxy the service over HTTPS. The fastest approach to achieve this was to create an OCI API Gateway and route as show below."),(0,r.mdx)("p",null,(0,r.mdx)("img",{alt:"OCI API Gateway route for the Pinferencia web service endpoint.",src:t(51918).Z,width:"2560",height:"1440"})),(0,r.mdx)("p",null,"This serves the web service publicly using an endpoint address that looks like this:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"https://{{UNIQUE_IDENTIFIER}}.apigateway.eu-frankfurt-1.oci.customer-oci.com/v1/genai/texttoimage\n")),(0,r.mdx)("h3",{id:"testing-the-model"},"Testing the Model"),(0,r.mdx)("p",null,"Pinferencia provides a ",(0,r.mdx)("a",{parentName:"p",href:"https://swagger.io/"},"Swagger")," UI that documents all the endpoints it is serving. You can use it to try out the models served. In this diagram, I am testing the image generation model."),(0,r.mdx)("p",null,(0,r.mdx)("img",{alt:"Swagger UI showing all the available endpoints and a way to try them.",src:t(95604).Z,width:"2560",height:"1440"})),(0,r.mdx)("p",null,"The input is a JSON object containing the prompt:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-json"},'{\n    "id": "string",\n    "parameters": {},\n    "data": "A cartoon image of a cat chasing a mouse."\n}\n')),(0,r.mdx)("p",null,"After the image has been placed in the bucket, it returns a HTTP response containing a JSON payload with the ",(0,r.mdx)("inlineCode",{parentName:"p"},"bucket_name")," and ",(0,r.mdx)("inlineCode",{parentName:"p"},"object_name")," that we can use to retrieve the object."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-json"},'{\n    "id": "string",\n    "model_name": "genai",\n    "model_version": "default",\n    "data": {\n        "bucket_name": "amiibo",\n        "object_name": "image20231113223047.png"\n    }\n}\n')),(0,r.mdx)("h2",{id:"the-nfc-enabled-web-application"},"The NFC-Enabled Web Application"),(0,r.mdx)("p",null,"I created an Oracle APEX application with the following features:"),(0,r.mdx)("ol",null,(0,r.mdx)("li",{parentName:"ol"},(0,r.mdx)("strong",{parentName:"li"},"Page 1.")," On the home page, the user scans a NFC tag containing a single text record that stores the prompt to submit to the deployed model."),(0,r.mdx)("li",{parentName:"ol"},"An administrative tool that allows an administrator to:",(0,r.mdx)("ol",{parentName:"li"},(0,r.mdx)("li",{parentName:"ol"},(0,r.mdx)("strong",{parentName:"li"},"Page 2"),". List tags in the inventory with buttons to manage or write prompts to a tag."),(0,r.mdx)("li",{parentName:"ol"},(0,r.mdx)("strong",{parentName:"li"},"Page 3"),". Register and manage a tag."),(0,r.mdx)("li",{parentName:"ol"},(0,r.mdx)("strong",{parentName:"li"},"Page 4"),". Write prompts to a tag.")))),(0,r.mdx)("p",null,"To keep this blog post readable, I will focus on two key aspects that allow the user to scan and generate an image."),(0,r.mdx)("p",null,"First, the ",(0,r.mdx)("em",{parentName:"p"},"Ajax Callback")," process that is called when an NFC tag containing a valid prompt is scanned successfully. Again, follow the embedded comments to understand what this code does."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-sql"},"declare\n    /**\n     * The collection name used for temporary storing the images.\n     */\n    c_collection_name apex_collections.collection_name%type := 'AMIIBO_ART';\n\n    /**\n     * The JavaScript event listener will read the tag and supply prompt using\n     * the x01 variable.\n     */\n    l_prompt apex_application.g_x01%type := apex_application.g_x01;\n\n    /**\n     * Utility variables for reading and parsing the results.\n     */\n    l_response clob;\n    l_content blob;\n    l_json_response apex_json.t_values;\nbegin\n    /**\n     * Call the deployed model's endpoint through the API gateway. The payload\n     * contains the prompt read from the NFC tag.\n     */\n    l_response := apex_web_service.make_rest_request(\n        p_url => 'https://{{UNIQUE_IDENTIFIER}}.apigateway.eu-frankfurt-1.oci.customer-oci.com/v1/genai/texttoimage'\n        , p_http_method => 'POST'\n        , p_body => json_object(\n            key 'data' value l_prompt\n        )\n    );\n\n    if apex_web_service.g_status_code = 200 then\n        /**\n         * If all goes well, parse the HTTP response's JSON payload to read the\n         * generated image's bucket and object name.\n         */\n        apex_json.parse(l_json_response, l_response);\n\n        /**\n         * Retrieve the object using the DBMS_CLOUD.GET_OBJECT function. Be sure\n         * to also create an IAM user, set up the OCI API credentials, and\n         * create the necessary policy to allow the IAM user to access the\n         * object.\n         */\n        l_content := dbms_cloud.get_object(\n            credential_name => 'MY_API_CREDENTIALS'\n            , object_uri => 'https://objectstorage.eu-frankfurt-1.oraclecloud.com/n/***/b/amiibo/o/'\n                ||  apex_json.get_varchar2(\n                        p_path => 'data.object_name'\n                        , p_values => l_json_response\n                    )\n        );\n\n        /**\n         * Not the best code here, but I am simply pushing the image into the\n         * an APEX collection.\n         */\n        apex_collection.create_or_truncate_collection(c_collection_name);\n        apex_collection.add_member(\n            p_collection_name => c_collection_name\n            , p_c001 => l_prompt\n            , p_blob001 => l_content\n        );\n\n        sys.htp.p('{\"message\":\"success\", \"prompt\": \"'||l_prompt||'\"}');\n    else\n        sys.htp.p('{\"message\":\"failed\"}');\n    end if;\nend;\n")),(0,r.mdx)("p",null,"This can be a long running process, and better strategies should be considered if larger images, the non-quantized model is used, or the pipeline is not running on a server with a GPU with sufficient memory. With a single Nvidia A10, I was able to get images to be generated in less than 20 seconds. While possible, using a CPU took more than 12 minutes in one attempt I made."),(0,r.mdx)("p",null,(0,r.mdx)("img",{alt:"Elapsed time using only CPU resources for the pipeline.",src:t(85352).Z,width:"2560",height:"1440"})),(0,r.mdx)("p",null,"On page 1, an Oracle APEX ",(0,r.mdx)("em",{parentName:"p"},"Card Region")," is added to render the image using the source query:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-sql"},"select\n    seq_id\n    , 'My Amiibo Art' as title\n    , c001 as prompt\n    , blob001 as content_blob\nfrom apex_collections\nwhere collection_name = 'AMIIBO_ART'\n")),(0,r.mdx)("p",null,"And a button that calls a dynamic action that executes the following JavaScript code:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-javascript"},'apex.message.alert(\n    "Close this alert, and then scan your Amiibo.",\n    null,\n    { style: "information" }\n);\n\ntry {\n    /**\n     * Instantiate the NFC reader object when the scan button is clicked.\n     */\n    const ndef = new NDEFReader();\n\n    /**\n     * Begin scanning.\n     */\n    ndef.scan();\n\n    /**\n     * Attach an event handler when there is an error reading the tag.\n     */\n    ndef.addEventListener(\n        "readingerror",\n        () => {\n            apex.message.alert(\n                "Failed to read data from the Amiibo. Please try again.",\n                null,\n                { style: "warning" }\n            );\n        }\n    );\n\n    /**\n     * Attach an event handler to handle the incoming data when a tag is scanned\n     * successfully. The data contains the serial number and its message\n     * payload.\n     */\n    ndef.addEventListener(\n        "reading",\n        ({ message, serialNumber }) => {\n            if(message.records.length > 0) {\n                /**\n                 * Get the first record.\n                 */\n                record = message.records[0];\n\n                /**\n                 * If it is of the expected record type, then process it.\n                 */\n                if(record.recordType === "text") {\n                    /**\n                     * First, instantiate a text decoder.\n                     */\n                    const decoder = new TextDecoder();\n\n                    let spinner = apex.util.showSpinner($("body"));\n\n                    /**\n                     * Call the Ajax callback with the text contained in the\n                     * tag\'s message payload.\n                     */\n                    apex.server.process(\n                        "TEXT_TO_IMAGE",\n                        {\n                            x01: decoder.decode(record.data)\n                        },\n                        {\n                            success: function( data )  {\n                                /**\n                                 * TODO:\n                                 * A page submit here because the Card region\n                                 * was not refreshing with the new image. Needs\n                                 * improvement.\n                                 */\n                                apex.page.submit();\n                            },\n                            error: function( jqXHR, textStatus, errorThrown ) {\n                                // handle error\n                            }\n                        }\n                    );\n                }\n            }\n        }\n    );\n} catch (error) {\n    apex.message.alert(`General error: {error}`, null, { style: "warning" });\n}\n')),(0,r.mdx)("p",null,"After the tag is scan, on the backend, you can see Pinferencia hard at work, generating images typically under 20 seconds."),(0,r.mdx)("youtube",{youTubeId:"uheDoKlAFdU"}),(0,r.mdx)("p",null,"And if all goes well, the page should be refreshed with the image generated by the model."),(0,r.mdx)("h2",{id:"writing-to-nfc-tags"},"Writing to NFC Tags"),(0,r.mdx)("p",null,'At the time of writing, the Web NFC API allows developers to read, write, and set a tag to "read-only" mode. In the application, I had created functionality for an administrator to maintain a collection of NFC tags, and to write prompts to them. On page 4, a button is attached to a dynamic action that runs JavaScript code to write to the tag. A sample of the code is as follows:'),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-javascript"},'try {\n    ...\n\n    ndef.addEventListener(\n        "reading",\n        ({ message, serialNumber }) => {\n            if(serialNumber === apex.item("P4_TAG_ID").getValue()) {\n                ndef.write(apex.item("P4_PROMPT").getValue());\n                apex.message.alert(\n                    "Prompt written to tag.",\n                    null,\n                    {style: "information"}\n                );\n            } else {\n                apex.message.alert(\n                    "Failed to write to tag. Tag ID mismatch.",\n                    null,\n                    {style: "danger"}\n                );\n            }\n        }\n    );\n} catch (error) {\n    apex.message.alert(`General error: {error}`, null, { style: "warning" });\n}\n')),(0,r.mdx)("p",null,"Easy eh?"),(0,r.mdx)("h2",{id:"summary"},"Summary"),(0,r.mdx)("p",null,"I worked on this fun project with two objectives in mind:"),(0,r.mdx)("ol",null,(0,r.mdx)("li",{parentName:"ol"},"How can I work with NFC tags in an Oracle APEX application."),(0,r.mdx)("li",{parentName:"ol"},"How can I host a Stable Diffusion model in the OCI.")),(0,r.mdx)("p",null,"Despite the limitations, I have learned quite a bit during this adventure."),(0,r.mdx)("ol",null,(0,r.mdx)("li",{parentName:"ol"},'Support for NFC tags is currently limited. Only Google Chrome on an Android device supports the experimental Web NFC API. And even so, we seem to be limited to reading, writing, and setting a tag to "read-only" mode. Hopefully, there will be future support password-lock a tag as well.'),(0,r.mdx)("li",{parentName:"ol"},"Not all Hugging Face pipelines are supported and can be deployed to the OCI Data Science platform."),(0,r.mdx)("li",{parentName:"ol"},"There are other software platforms that can be used to deploy ML models, for example, Pinferencia. I don't consider it ready for production use, but it has been very easy to set up, run, and host a ML model.")),(0,r.mdx)("p",null,"Hope you enjoyed reading about this as much as I had working and writing on the project. If you ar interested to discuss possible solutions to your unique business challenge, please reach out to me using this ",(0,r.mdx)("a",{parentName:"p",href:"https://cal.com/fuzziebrain/iaas-consult"},"form"),"."),(0,r.mdx)("blockquote",null,(0,r.mdx)("p",{parentName:"blockquote"},(0,r.mdx)("strong",{parentName:"p"},"Credits")),(0,r.mdx)("ul",{parentName:"blockquote"},(0,r.mdx)("li",{parentName:"ul"},"Banner image generated using Stability AI's ",(0,r.mdx)("a",{parentName:"li",href:"https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0"},"Stable Diffusion")," model."))))}p.isMDXComponent=!0},51918:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/apigw-route-29651e67af64b9e698f6b103f0e3cf44.png"},85352:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/elapsed-time-with-cpu-only-eeaf9ccb0ae9facf788d9eb69a4d0afb.png"},57699:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image20231119221347-f7f8e843ef24108f6ff6b29e10bd7527.png"},95604:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/swagger-ui-68ecb832cc8fc650997e2232db31a795.png"}}]);