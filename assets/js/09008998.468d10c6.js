"use strict";(self.webpackChunknewsite=self.webpackChunknewsite||[]).push([[42869],{3905:(e,t,a)=>{a.r(t),a.d(t,{MDXContext:()=>p,MDXProvider:()=>u,mdx:()=>g,useMDXComponents:()=>h,withMDXComponents:()=>c});var n=a(67294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(){return r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},r.apply(this,arguments)}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var p=n.createContext({}),c=function(e){return function(t){var a=h(t.components);return n.createElement(e,r({},t,{components:a}))}},h=function(e){var t=n.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},u=function(e){var t=h(e.components);return n.createElement(p.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},f=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,o=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=h(a),u=i,d=c["".concat(o,".").concat(u)]||c[u]||m[u]||r;return a?n.createElement(d,s(s({ref:t},p),{},{components:a})):n.createElement(d,s({ref:t},p))}));function g(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,o=new Array(r);o[0]=f;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:i,o[1]=s;for(var p=2;p<r;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}f.displayName="MDXCreateElement"},73279:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var n=a(87462),i=(a(67294),a(3905));const r={title:"Build Two Walls",tags:["orclapex","security","authentication","two-factor","multi-factor","2fa","mfa"],categories:["Technology","Programming","Oracle Application Express"],slug:"id/1718",authors:["fuzziebrain"],date:new Date("2018-10-18T00:28:32.000Z")},o=void 0,s={permalink:"/content/id/1718",source:"@site/posts/build-two-walls/index.md",title:"Build Two Walls",description:"1280 720 The Great Wall of China",date:"2018-10-18T00:28:32.000Z",formattedDate:"October 18, 2018",tags:[{label:"orclapex",permalink:"/content/tags/orclapex"},{label:"security",permalink:"/content/tags/security"},{label:"authentication",permalink:"/content/tags/authentication"},{label:"two-factor",permalink:"/content/tags/two-factor"},{label:"multi-factor",permalink:"/content/tags/multi-factor"},{label:"2fa",permalink:"/content/tags/2-fa"},{label:"mfa",permalink:"/content/tags/mfa"}],readingTime:3.545,hasTruncateMarker:!0,authors:[{name:"Adrian Png",title:"Senior Cloud Solutions Architect @ Insum",url:"https://github.com/fuzziebrain",imageURL:"https://github.com/fuzziebrain.png",key:"fuzziebrain"}],frontMatter:{title:"Build Two Walls",tags:["orclapex","security","authentication","two-factor","multi-factor","2fa","mfa"],categories:["Technology","Programming","Oracle Application Express"],slug:"id/1718",authors:["fuzziebrain"],date:"2018-10-18T00:28:32.000Z"},prevItem:{title:"Sweet 18 - A New Oracle XE Release",permalink:"/content/id/1719"},nextItem:{title:"ODC Appreciation Day: Goodbye Oracle Multimedia",permalink:"/content/id/1717"}},l={authorsImageUrls:[void 0]},p=[{value:"The Code",id:"the-code",level:2},{value:"Highlights",id:"highlights",level:2},{value:"Registration",id:"registration",level:3},{value:"Authentication",id:"authentication",level:3},{value:"OTP Validation",id:"otp-validation",level:3},{value:"Closing",id:"closing",level:2}],c={toc:p};function h(e){let{components:t,...r}=e;return(0,i.mdx)("wrapper",(0,n.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,i.mdx)("p",null,(0,i.mdx)("img",{alt:"1280 720 The Great Wall of China",src:a(7092).Z,width:"1280",height:"720"})),(0,i.mdx)("p",null,"Authentication is an essential component of any enterprise application. These days though, it isn't enough to protect your applications with only a username and password. These are easily stolen by key loggers, sniffing non-encrypted HTTP traffic, phishing, hacked Internet services and the list goes on. To make matters worse, many users have a poor habit of reusing passwords that thieves then use to penetrate other systems. I have had my fair share of that experience."),(0,i.mdx)("p",null,"The question is, can we implement ",(0,i.mdx)("a",{parentName:"p",href:"https://wikipedia.org/wiki/Multi-factor_authentication"},"two-factor authentication")," (TFA) in ",(0,i.mdx)("a",{parentName:"p",href:"https://apex.oracle.com"},"Oracle Application Express")," (APEX)?"),(0,i.mdx)("p",null,(0,i.mdx)("strong",{parentName:"p"},"Yes we can!")),(0,i.mdx)("h2",{id:"the-code"},"The Code"),(0,i.mdx)("p",null,"Right around the time when I grew interested in implementing the ",(0,i.mdx)("a",{parentName:"p",href:"https://wikipedia.org/wiki/Time-based_One-time_Password_algorithm"},"Time-based One-time Password")," (TOTP) algorithm, I stumbled upon ",(0,i.mdx)("a",{parentName:"p",href:"https://community.oracle.com/thread/3905510"},"code")," written by Rabbit on the Oracle Community Forums, only months earlier. Hurrah! I didn't have to deal with the mathematical intricacies of implementing the algorithm in PL/SQL code."),(0,i.mdx)("p",null,"After discussing with ",(0,i.mdx)("a",{parentName:"p",href:"https://twitter.com/martindsouza"},"Martin D'Souza"),", we decided that the best way to share this useful algorithm was through OraOpenSource ",(0,i.mdx)("a",{parentName:"p",href:"https://github.com/OraOpenSource/oos-utils"},"oos-utils"),". All it needed was some additional functionality to make it useful for implementing a custom authentication scheme with TFA support in APEX. We also swapped out the ",(0,i.mdx)("inlineCode",{parentName:"p"},"dbms_crypto")," requirement and used ",(0,i.mdx)("a",{parentName:"p",href:"https://twitter.com/AntonScheffer"},"Anton Scheffer's")," ",(0,i.mdx)("inlineCode",{parentName:"p"},"oos_util_crypto")," library to perform the ",(0,i.mdx)("a",{parentName:"p",href:"https://wikipedia.org/wiki/HMAC"},"HMAC")," hashing instead. This means, the code should be usable in your workspace on ",(0,i.mdx)("a",{parentName:"p",href:"https://apex.oracle.com"},"apex.oracle.com"),"."),(0,i.mdx)("p",null,"What was missing in the release though, was a demo application to showcase its use, so two years later, here it is!"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},"{% fa globe %} ",(0,i.mdx)("a",{parentName:"li",href:"https://apeks.app/ords/f?p=TFADEMO"},"Demo application")),(0,i.mdx)("li",{parentName:"ul"},"{% fa git %} ",(0,i.mdx)("a",{parentName:"li",href:"https://github.com/fuzziebrain/orclapex-tfa-demo"},"Source code"))),(0,i.mdx)("h2",{id:"highlights"},"Highlights"),(0,i.mdx)("p",null,"The following are a few key points about the implementation that I thought might be of interest."),(0,i.mdx)("h3",{id:"registration"},"Registration"),(0,i.mdx)("p",null,'The registration does not automatically "turn on" TFA for new accounts. The new user is expected to login to the system and activate the TFA protection. During registration, a random and unique key was generated for the account. Whenever TFA is activated, a QR code is generated using the function ',(0,i.mdx)("inlineCode",{parentName:"p"},"oos_util_totp.format_key_uri"),', user\'s "shared secret" and a suitable, trusted QR code generation JavaScript library. This allows the user to setup the security application and generate one-time passwords (OTP). The user must validate a OTP before the feature is enabled for the account.'),(0,i.mdx)("h3",{id:"authentication"},"Authentication"),(0,i.mdx)("p",null,"The authentication process will allow users to authenticate with or without OTP validation depending on the user's preference. The original (default) login page 9999 was modified to support both authentication workflows."),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"Login")," process typically calls ",(0,i.mdx)("inlineCode",{parentName:"p"},"apex_authentication.login")," that triggers a sequence of events ",(0,i.mdx)("a",{parentName:"p",href:"https://docs.oracle.com/database/apex-18.2/AEAPI/LOGIN-Procedure.htm#AEAPI29157"},"listed")," in the official APEX documentation. The process calls an authentication function that matches usernames and passwords. If the function returns true, then the APEX engine will, in a nutshell, set the username for the session and redirect to the requested resource. This function call was replaced with a procedure, ",(0,i.mdx)("inlineCode",{parentName:"p"},"pkg_tfa_apex.p_authenticate_user"),"."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-plsql"},"if l_password_hash = f_hash_password(p_password => p_password) then\n  if l_tfa_enabled = 0 then\n    apex_authentication.post_login(\n      p_username => p_username\n      , p_password => null\n    );\n    apex_util.clear_page_cache();\n  end if;\nelse\n  raise login_failed;\nend if;\n")),(0,i.mdx)("p",null,"If TFA is ",(0,i.mdx)("strong",{parentName:"p"},"not")," enabled, then ",(0,i.mdx)("inlineCode",{parentName:"p"},"apex_authentication.post_login")," is called. We have already established that the username and password are correct, so this allows us to bypass the first two steps in a typical authentication sequence."),(0,i.mdx)("p",null,"Usually, the default login page has a final process that clears the session state for the page, but that was removed. A branch to a second-step login page (10000) was added. It passes the username entered on page 9999 to the the next page for OTP validation. The username is used to retrieve the user's shared secret that is is required by ",(0,i.mdx)("inlineCode",{parentName:"p"},"oos_util_totp.validate_otp"),". Hence, I opted to call ",(0,i.mdx)("inlineCode",{parentName:"p"},"apex_util.clear_page_cache")," only if TFA was turned off."),(0,i.mdx)("h3",{id:"otp-validation"},"OTP Validation"),(0,i.mdx)("p",null,'The login process redirects to a second login page that requires the user to enter the OTP from a "registered" security app. This is verified (must match with what the system generates) using a page validation. If that checks out, then we will proceed to call the ',(0,i.mdx)("inlineCode",{parentName:"p"},"apex_authentication.post_login")," procedure and complete the login process."),(0,i.mdx)("h2",{id:"closing"},"Closing"),(0,i.mdx)("p",null,"As always, security is an important issue in any software application we build. I am always learning, so please drop me a note if you spot anything wrong with the approach, or have suggestions for improvement."),(0,i.mdx)("p",null,"Thanks for reading!"))}h.isMDXComponent=!0},7092:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/china-2097075_1280x720-3b0d33b35a0d3974025744eab9ecf129.jpg"}}]);